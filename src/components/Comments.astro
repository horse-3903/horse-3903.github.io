---
const { pageTitle, pageUrl, pageId } = Astro.props;
---

<section id="comments" class="mt-12 mb-12 transition-colors duration-300">
  <div
    id="comment-card"
    class="card-base card-shadow p-6 border border-white/20 dark:border-white/30 transition-all duration-300"
  >
    <h2 class="text-2xl font-semibold mb-5 text-90 tracking-tight">Comments</h2>

    <div
      id="cusdis_thread"
      data-host="https://cusdis.com"
      data-app-id="a3ed583a-9ea0-4074-9249-f44ef13e6d9b"
      data-page-id={pageId}
      data-page-url={pageUrl}
      data-page-title={pageTitle}
      data-theme="light"
    ></div>
  </div>

  <script async defer is:inline src="https://cusdis.com/js/cusdis.es.js"></script>

  <script is:inline>
    if (typeof window !== "undefined") {
      let currentTheme = "light";

      function renderCusdis(theme = "light") {
        const thread = document.getElementById("cusdis_thread");
        if (!thread) return;

        // Clear old iframe before re-rendering
        thread.innerHTML = "";
        thread.setAttribute("data-theme", theme);

        window.CUSDIS?.renderTo(thread);
      }

      function initCusdis() {
        window.CUSDIS?.initial?.();

        const isDark = document.documentElement.classList.contains("dark");
        currentTheme = isDark ? "dark" : "light";
        renderCusdis(currentTheme);

        // Resize iframe dynamically to fit card height
        window.addEventListener("message", (event) => {
          if (event.data?.from === "cusdis" && event.data.event === "resize") {
            const iframe = document.querySelector("#cusdis_thread iframe");
            if (iframe) {
              iframe.style.height = event.data.data + "px";
              iframe.style.display = "block";
            }
          }
        });

        // Watch theme changes
        const observer = new MutationObserver(() => {
          const isDark = document.documentElement.classList.contains("dark");
          const newTheme = isDark ? "dark" : "light";
          if (newTheme !== currentTheme) {
            currentTheme = newTheme;
            renderCusdis(newTheme); // instant re-render
            const card = document.getElementById("comment-card");
            if (card) {
              card.style.backgroundColor = isDark ? "#111" : "var(--card-bg)";
            }
          }
        });
        observer.observe(document.documentElement, {
          attributes: true,
          attributeFilter: ["class"],
        });
      }

      if (document.readyState === "loading") {
        window.addEventListener("DOMContentLoaded", initCusdis);
      } else {
        initCusdis();
      }
    }
  </script>
</section>
