---
const { pageTitle, pageUrl, pageId } = Astro.props;
---

<section id="comments" class="mt-12 mb-12">
  <div class="card-base card-shadow p-6">
    <h2 class="text-2xl font-semibold mb-5 text-90 tracking-tight">Comments</h2>

    <div
      id="cusdis_thread"
      data-host="https://cusdis.com"
      data-app-id="a3ed583a-9ea0-4074-9249-f44ef13e6d9b"
      data-page-id={pageId}
      data-page-url={pageUrl}
      data-page-title={pageTitle}
      data-theme="light"  <!-- manually force light theme -->
    ></div>
  </div>

  <script async defer src="https://cusdis.com/js/cusdis.es.js"></script>

  <script is:inline>
    if (typeof window !== "undefined") {
      // initialize widget
      const initCusdis = () => {
        window.CUSDIS?.initial?.();

        // Force light theme (remove dark background)
        window.CUSDIS?.setTheme?.("light");

        // Inject CSS into iframe when it appears
        const fixIframe = () => {
          const iframe = document.querySelector("#cusdis_thread iframe");
          if (!iframe) {
            setTimeout(fixIframe, 300);
            return;
          }
          iframe.addEventListener("load", () => {
            try {
              const doc = iframe.contentDocument || iframe.contentWindow.document;
              const style = doc.createElement("style");
              style.textContent = `
                body, html {
                  background: transparent !important;
                  color: var(--text-90, #222) !important;
                }
                .cusdis-thread, .cusdis-comment, .cusdis-input, .cusdis-textarea {
                  background: transparent !important;
                }
              `;
              doc.head.appendChild(style);
            } catch (e) {
              console.warn("Unable to inject CSS into Cusdis iframe (CORS probable).");
            }
          });
        };
        fixIframe();
      };

      if (document.readyState === "loading") {
        window.addEventListener("DOMContentLoaded", initCusdis);
      } else {
        initCusdis();
      }
    }
  </script>
</section>
